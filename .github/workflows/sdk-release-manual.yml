name: SDK Release (Manual)

# ÊâãÂä®Ëß¶ÂèëÂ∑•‰ΩúÊµÅÔºöÂÖÅËÆ∏ÂºÄÂèëËÄÖÊâãÂä®Ëß¶Âèë SDK ÈáçÊñ∞ÁîüÊàê
# ÊîØÊåÅÈÄâÊã©ÊÄßÁîüÊàêÔºà‰ªÖ Python„ÄÅ‰ªÖ TypeScript ÊàñÂÖ®ÈÉ®ÔºâÂíå dry-run Ê®°Âºè

on:
  workflow_dispatch:
    inputs:
      sdk_selection:
        description: 'Select SDKs to build'
        required: true
        type: choice
        options:
          - all
          - python
          - typescript
        default: all

      dry_run:
        description: 'Dry run mode (no actual changes)'
        required: false
        type: boolean
        default: false

      skip_validation:
        description: 'Skip validation checks (for debugging)'
        required: false
        type: boolean
        default: false

# Âπ∂ÂèëÊéßÂà∂ÔºöÂêåÊó∂Âè™ÂÖÅËÆ∏‰∏Ä‰∏™ÂèëÂ∏ÉÊµÅÊ∞¥Á∫øËøêË°å
concurrency:
  group: sdk-release-manual-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  # Job 1: È™åËØÅËæìÂÖ•ÂèÇÊï∞
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      build_python: ${{ steps.validate.outputs.build_python }}
      build_typescript: ${{ steps.validate.outputs.build_typescript }}

    steps:
      - name: Validate and process inputs
        id: validate
        run: |
          echo "## Manual Trigger Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **SDK Selection**: ${{ github.event.inputs.sdk_selection }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Validation**: ${{ github.event.inputs.skip_validation }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Á°ÆÂÆöË¶ÅÊûÑÂª∫Âì™‰∫õ SDK
          if [ "${{ github.event.inputs.sdk_selection }}" = "all" ] || [ "${{ github.event.inputs.sdk_selection }}" = "python" ]; then
            echo "build_python=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Python SDK will be built" >> $GITHUB_STEP_SUMMARY
          else
            echo "build_python=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Python SDK will be skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.sdk_selection }}" = "all" ] || [ "${{ github.event.inputs.sdk_selection }}" = "typescript" ]; then
            echo "build_typescript=true" >> $GITHUB_OUTPUT
            echo "‚úÖ TypeScript SDK will be built" >> $GITHUB_STEP_SUMMARY
          else
            echo "build_typescript=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  TypeScript SDK will be skipped" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: ÁîüÊàê Python SDK
  generate-python:
    name: Generate Python SDK
    needs: validate-inputs
    if: needs.validate-inputs.outputs.build_python == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        working-directory: sdks/python
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv venv
          source .venv/bin/activate || . .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Generate Python SDK
        run: |
          chmod +x scripts/ci/generate-python-sdk.sh

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîç DRY RUN MODE: Would generate Python SDK"
            echo "Command: ./scripts/ci/generate-python-sdk.sh"
            ./scripts/ci/generate-python-sdk.sh  # Still run to show output
            echo "‚ö†Ô∏è  Dry run mode - no files will be committed"
          else
            ./scripts/ci/generate-python-sdk.sh
          fi

      - name: Validate Python SDK (optional)
        if: github.event.inputs.skip_validation != 'true' && github.event.inputs.dry_run != 'true'
        working-directory: sdks/python
        run: |
          echo "Running Python SDK validation..."
          source .venv/bin/activate || . .venv/bin/activate

          # Run ruff
          echo "Running ruff..."
          uv run ruff check . || echo "‚ö†Ô∏è  Ruff check found issues"

          # Run mypy
          echo "Running mypy..."
          uv run mypy src || echo "‚ö†Ô∏è  Mypy found issues"

      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: python-sdk-generated-manual
          path: |
            sdks/python/src/tidas_sdk/**/*.py
          retention-days: 7

  # Job 3: ÁîüÊàê TypeScript SDK
  generate-typescript:
    name: Generate TypeScript SDK
    needs: validate-inputs
    if: needs.validate-inputs.outputs.build_typescript == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: sdks/typescript/package-lock.json

      - name: Install dependencies
        working-directory: sdks/typescript
        run: npm ci

      - name: Generate TypeScript SDK
        run: |
          chmod +x scripts/ci/generate-typescript-sdk.sh

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîç DRY RUN MODE: Would generate TypeScript SDK"
            echo "Command: ./scripts/ci/generate-typescript-sdk.sh"
            ./scripts/ci/generate-typescript-sdk.sh  # Still run to show output
            echo "‚ö†Ô∏è  Dry run mode - no files will be committed"
          else
            ./scripts/ci/generate-typescript-sdk.sh
          fi

      - name: Validate TypeScript SDK (optional)
        if: github.event.inputs.skip_validation != 'true' && github.event.inputs.dry_run != 'true'
        working-directory: sdks/typescript
        run: |
          echo "Running TypeScript SDK validation..."

          # Run ESLint
          echo "Running ESLint..."
          npm run lint || echo "‚ö†Ô∏è  ESLint found issues"

          # Run TypeScript compiler check
          echo "Running TypeScript check..."
          npm run typecheck || echo "‚ö†Ô∏è  TypeScript found issues"

      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: typescript-sdk-generated-manual
          path: |
            sdks/typescript/src/**/*.ts
          retention-days: 7

  # Job 4: Ê±áÊÄªÁªìÊûú
  summary:
    name: Pipeline Summary
    needs: [validate-inputs, generate-python, generate-typescript]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate workflow summary
        run: |
          echo "# SDK Release Pipeline Summary (Manual)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ‚öôÔ∏è  Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **SDK Selection**: ${{ github.event.inputs.sdk_selection }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Validation**: ${{ github.event.inputs.skip_validation }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üì¶ SDK Generation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-inputs.outputs.build_python }}" = "true" ]; then
            if [ "${{ needs.generate-python.result }}" = "success" ]; then
              echo "- ‚úÖ **Python SDK**: Generated successfully" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.generate-python.result }}" = "skipped" ]; then
              echo "- ‚è≠Ô∏è  **Python SDK**: Skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå **Python SDK**: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ‚è≠Ô∏è  **Python SDK**: Not selected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-inputs.outputs.build_typescript }}" = "true" ]; then
            if [ "${{ needs.generate-typescript.result }}" = "success" ]; then
              echo "- ‚úÖ **TypeScript SDK**: Generated successfully" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.generate-typescript.result }}" = "skipped" ]; then
              echo "- ‚è≠Ô∏è  **TypeScript SDK**: Skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ùå **TypeScript SDK**: Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ‚è≠Ô∏è  **TypeScript SDK**: Not selected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "‚ö†Ô∏è  **Dry run mode** - No files were actually modified or committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This is an MVP implementation (User Story 1)*" >> $GITHUB_STEP_SUMMARY
          echo "*Future phases will add automatic versioning and publication*" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          python_result="${{ needs.generate-python.result }}"
          typescript_result="${{ needs.generate-typescript.result }}"
          build_python="${{ needs.validate-inputs.outputs.build_python }}"
          build_typescript="${{ needs.validate-inputs.outputs.build_typescript }}"

          failed=false

          if [ "$build_python" = "true" ] && [ "$python_result" != "success" ]; then
            echo "‚ùå Python SDK generation was selected but failed"
            failed=true
          fi

          if [ "$build_typescript" = "true" ] && [ "$typescript_result" != "success" ]; then
            echo "‚ùå TypeScript SDK generation was selected but failed"
            failed=true
          fi

          if [ "$failed" = "true" ]; then
            exit 1
          else
            echo "‚úÖ All selected SDK generation jobs completed successfully"
            exit 0
          fi
