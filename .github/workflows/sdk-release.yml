# name: SDK Release (Auto)

# # Ëá™Âä®Ëß¶ÂèëÂ∑•‰ΩúÊµÅÔºöÂΩì tidas-tools submodule Êõ¥Êñ∞Êó∂Ëá™Âä®ÈáçÊñ∞ÁîüÊàê SDK

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'tidas-tools'
#       - '.github/workflows/sdk-release.yml'

#   # ÂèØÈÄâ: ÂÆöÊúüÊ£ÄÊü•ÔºàÊØèÂ§©‰∏ÄÊ¨°Ôºâ
#   schedule:
#     - cron: '0 0 * * *'

# # Âπ∂ÂèëÊéßÂà∂ÔºöÂêåÊó∂Âè™ÂÖÅËÆ∏‰∏Ä‰∏™ÂèëÂ∏ÉÊµÅÊ∞¥Á∫øËøêË°å
# concurrency:
#   group: sdk-release-${{ github.ref }}
#   cancel-in-progress: false  # ÊéíÈòüËÄåÈùûÂèñÊ∂à

# permissions:
#   contents: write  # Áî®‰∫éÂàõÂª∫ Git tags ÂíåÊèê‰∫§ÁâàÊú¨ÂèòÊõ¥
#   actions: read    # Áî®‰∫éËØªÂèñÂ∑•‰ΩúÊµÅÁä∂ÊÄÅ

# jobs:
#   # Job 1: Ê£ÄÊµã submodule ÂèòÊõ¥
#   detect-changes:
#     name: Detect Submodule Changes
#     runs-on: ubuntu-latest
#     outputs:
#       changed: ${{ steps.check.outputs.changed }}
#       old_commit: ${{ steps.check.outputs.old_commit }}
#       new_commit: ${{ steps.check.outputs.new_commit }}

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 2  # Ëé∑ÂèñÊúÄËøë‰∏§Ê¨°Êèê‰∫§‰ª•‰æøÊØîËæÉ
#           submodules: recursive

#       - name: Check submodule changes
#         id: check
#         run: |
#           chmod +x scripts/ci/detect-submodule-changes.sh

#           # ËøêË°åÊ£ÄÊµãËÑöÊú¨
#           output=$(./scripts/ci/detect-submodule-changes.sh)
#           echo "Detection output: $output"

#           # Ëß£Êûê JSON ËæìÂá∫
#           changed=$(echo "$output" | jq -r '.changed')
#           old_commit=$(echo "$output" | jq -r '.old_commit // "N/A"')
#           new_commit=$(echo "$output" | jq -r '.new_commit // "N/A"')

#           echo "changed=$changed" >> $GITHUB_OUTPUT
#           echo "old_commit=$old_commit" >> $GITHUB_OUTPUT
#           echo "new_commit=$new_commit" >> $GITHUB_OUTPUT

#           if [ "$changed" = "true" ]; then
#             echo "‚úÖ Submodule changed detected: $old_commit ‚Üí $new_commit"
#           else
#             echo "‚ÑπÔ∏è  No submodule changes detected, skipping SDK regeneration"
#           fi

#   # Job 2: ÁîüÊàê Python SDK
#   generate-python:
#     name: Generate Python SDK
#     needs: detect-changes
#     if: needs.detect-changes.outputs.changed == 'true'
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           submodules: recursive

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.12'

#       - name: Install dependencies
#         working-directory: sdks/python
#         run: |
#           python -m pip install --upgrade pip
#           pip install uv
#           uv venv
#           source .venv/bin/activate || . .venv/bin/activate
#           uv pip install -e ".[dev]"

#       - name: Generate Python SDK
#         run: |
#           chmod +x scripts/ci/generate-python-sdk.sh
#           ./scripts/ci/generate-python-sdk.sh

#       - name: Upload generated files
#         uses: actions/upload-artifact@v4
#         with:
#           name: python-sdk-generated
#           path: |
#             sdks/python/src/tidas_sdk/**/*.py
#           retention-days: 7

#       - name: Show generation summary
#         run: |
#           echo "## Python SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "‚úÖ Python SDK generated successfully" >> $GITHUB_STEP_SUMMARY
#           echo "üìÅ Output: sdks/python/src/tidas_sdk/" >> $GITHUB_STEP_SUMMARY
#           echo "üîó Submodule commit: ${{ needs.detect-changes.outputs.new_commit }}" >> $GITHUB_STEP_SUMMARY

#   # Job 3: ÁîüÊàê TypeScript SDK
#   generate-typescript:
#     name: Generate TypeScript SDK
#     needs: detect-changes
#     if: needs.detect-changes.outputs.changed == 'true'
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           submodules: recursive

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '18'
#           cache: 'npm'
#           cache-dependency-path: sdks/typescript/package-lock.json

#       - name: Install dependencies
#         working-directory: sdks/typescript
#         run: npm ci

#       - name: Generate TypeScript SDK
#         run: |
#           chmod +x scripts/ci/generate-typescript-sdk.sh
#           ./scripts/ci/generate-typescript-sdk.sh

#       - name: Upload generated files
#         uses: actions/upload-artifact@v4
#         with:
#           name: typescript-sdk-generated
#           path: |
#             sdks/typescript/src/**/*.ts
#           retention-days: 7

#       - name: Show generation summary
#         run: |
#           echo "## TypeScript SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "‚úÖ TypeScript SDK generated successfully" >> $GITHUB_STEP_SUMMARY
#           echo "üìÅ Output: sdks/typescript/src/" >> $GITHUB_STEP_SUMMARY
#           echo "üîó Submodule commit: ${{ needs.detect-changes.outputs.new_commit }}" >> $GITHUB_STEP_SUMMARY

#   # Job 4: Ê±áÊÄªÁªìÊûú
#   summary:
#     name: Pipeline Summary
#     needs: [detect-changes, generate-python, generate-typescript]
#     if: always()
#     runs-on: ubuntu-latest

#     steps:
#       - name: Generate workflow summary
#         run: |
#           echo "# SDK Release Pipeline Summary" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "**Trigger**: Automatic (push to main)" >> $GITHUB_STEP_SUMMARY
#           echo "**Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY

#           if [ "${{ needs.detect-changes.outputs.changed }}" = "true" ]; then
#             echo "## üîÑ Submodule Changes Detected" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY
#             echo "- **Old commit**: \`${{ needs.detect-changes.outputs.old_commit }}\`" >> $GITHUB_STEP_SUMMARY
#             echo "- **New commit**: \`${{ needs.detect-changes.outputs.new_commit }}\`" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY

#             echo "## üì¶ SDK Generation Results" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY

#             if [ "${{ needs.generate-python.result }}" = "success" ]; then
#               echo "- ‚úÖ **Python SDK**: Generated successfully" >> $GITHUB_STEP_SUMMARY
#             else
#               echo "- ‚ùå **Python SDK**: Failed or skipped" >> $GITHUB_STEP_SUMMARY
#             fi

#             if [ "${{ needs.generate-typescript.result }}" = "success" ]; then
#               echo "- ‚úÖ **TypeScript SDK**: Generated successfully" >> $GITHUB_STEP_SUMMARY
#             else
#               echo "- ‚ùå **TypeScript SDK**: Failed or skipped" >> $GITHUB_STEP_SUMMARY
#             fi
#           else
#             echo "## ‚ÑπÔ∏è  No Changes Detected" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY
#             echo "No submodule changes detected. SDK regeneration was skipped." >> $GITHUB_STEP_SUMMARY
#           fi

#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "---" >> $GITHUB_STEP_SUMMARY
#           echo "*This is an MVP implementation (User Story 1)*" >> $GITHUB_STEP_SUMMARY
#           echo "*Future phases will add validation and publication*" >> $GITHUB_STEP_SUMMARY

#       - name: Check overall status
#         if: needs.detect-changes.outputs.changed == 'true'
#         run: |
#           if [ "${{ needs.generate-python.result }}" = "success" ] && [ "${{ needs.generate-typescript.result }}" = "success" ]; then
#             echo "‚úÖ All SDK generation jobs completed successfully"
#             exit 0
#           else
#             echo "‚ùå One or more SDK generation jobs failed"
#             exit 1
#           fi
