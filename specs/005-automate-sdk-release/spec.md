# 功能规格说明：自动化 SDK 发布流水线

**功能分支**: `005-automate-sdk-release`
**创建日期**: 2025-11-03
**状态**: 草稿
**输入**: 用户描述："增加自动化更新、发布不同语言sdk的功能, 当git submodule更新时，自动重新生成python sdk和typescript sdk并执行lint, test, 发布等操作"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 模式更新时自动重新生成 SDK (优先级: P1)

当 TIDAS 模式定义（存储在 git submodule 中）更新时，SDK 生成流水线自动检测变更并重新生成 Python 和 TypeScript 两个 SDK，使其包含最新的模式更改。这确保了 SDK 与规范模式保持同步，无需人工干预。

**优先级原因**: 这是核心功能 - 自动检测和重新生成。没有这个功能，整个自动化流水线无法运作。它通过消除手动重新生成步骤立即提供价值。

**独立测试**: 可以通过更新模式 submodule、提交更改并验证 Python 和 TypeScript SDK 都已使用新的模式定义重新生成来完整测试。

**验收场景**:

1. **假设** 模式 submodule 处于 1.0 版本 **当** submodule 更新到 1.1 版本 **那么** 系统检测到变更并触发 Python 和 TypeScript SDK 的重新生成
2. **假设** SDK 重新生成被触发 **当** 生成过程完成 **那么** Python 和 TypeScript SDK 都包含更新后的模式定义
3. **假设** 模式 submodule 更新包含新的实体类型 **当** SDK 重新生成 **那么** 两个 SDK 都包含新实体类型的类型化包装器

---

### 用户故事 2 - 自动化质量验证 (优先级: P2)

SDK 重新生成后，流水线自动运行代码检查和测试，确保生成的代码符合质量标准且不会引入回归问题。这在 SDK 发布前及早发现问题。

**优先级原因**: 质量验证在发布前至关重要，但重新生成本身（P1）必须先工作。这防止有问题的 SDK 到达用户手中并维护代码质量标准。

**独立测试**: 可以通过在重新生成的 SDK 上触发验证流水线并验证代码检查器和测试成功执行，或正确报告失败来独立测试。

**验收场景**:

1. **假设** SDK 已重新生成 **当** 验证阶段开始 **那么** Python 和 TypeScript 的代码质量检查自动运行
2. **假设** 代码质量检查通过 **当** 测试阶段开始 **那么** 两个 SDK 的所有单元测试和集成测试都执行
3. **假设** 发生任何代码检查或测试失败 **当** 验证完成 **那么** 流水线停止并报告具体失败及可操作的错误消息
4. **假设** 所有验证通过 **当** 流水线继续 **那么** 系统进入发布阶段

---

### 用户故事 3 - 自动化 SDK 发布 (优先级: P3)

验证成功后，流水线自动将更新的 SDK 发布到各自的包注册表。这完成了端到端自动化，使用户能够使用新的 SDK 版本。

**优先级原因**: 发布是依赖于重新生成（P1）和验证（P2）的最后步骤。虽然重要，但即使没有自动发布，只要重新生成和验证工作，系统也能提供价值。

**独立测试**: 可以通过在已验证的 SDK 上运行发布工作流并验证新版本以正确的版本号和元数据出现在包注册表中来测试。

**验收场景**:

1. **假设** 所有验证通过 **当** 发布阶段开始 **那么** 版本号按照语义化版本规则自动递增
2. **假设** 版本号已更新 **当** 发布执行 **那么** Python 和 TypeScript SDK 发布到各自的包注册表
3. **假设** 发布成功 **当** 过程完成 **那么** 用户可以从包注册表安装新的 SDK 版本
4. **假设** 任何 SDK 发布失败 **当** 错误发生 **那么** 系统报告失败且不发布任何其他 SDK（原子操作）

---

### 边缘情况

- 当 submodule 更新包含需要手动调整 SDK 代码的破坏性模式更改时会发生什么？
- 系统如何处理部分失败（例如 Python SDK 验证通过但 TypeScript SDK 失败）？
- 当流水线在短时间内被多次触发时会发生什么（例如多个模式提交）？
- 系统如何处理发布到包注册表时的身份验证/凭证失败？
- 当网络问题阻止 submodule 更新或包注册表访问时会发生什么？
- 系统如何处理版本冲突（例如计算的下一个版本已在注册表中存在）？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须自动检测包含模式定义的外部依赖源何时更新
- **FR-002**: 系统必须在检测到模式更改时触发 Python 和 TypeScript SDK 的重新生成
- **FR-003**: 系统必须在重新生成后对每个 SDK 执行语言特定的代码质量检查
- **FR-004**: 系统必须在代码质量检查通过后运行两个 SDK 的所有现有测试套件
- **FR-005**: 系统必须在任何代码检查或测试步骤失败时停止流水线并报告错误
- **FR-006**: 系统必须按照语义化版本规则自动确定下一个版本号
- **FR-007**: 系统必须将已验证的 SDK 发布到各自的语言包注册表
- **FR-008**: 系统必须在每个流水线阶段（检测、生成、验证、发布）提供清晰的状态报告
- **FR-009**: 系统必须支持自动触发（模式更新时）和手动触发（开发人员主动发起），以便进行测试、调试或重试失败的发布
- **FR-010**: 系统必须从密钥管理服务中安全检索包注册表发布凭证，确保凭证的集中管理和安全存储
- **FR-011**: 流水线必须在自动触发时总是递增 PATCH 版本号，在手动触发时允许开发人员选择递增 MAJOR、MINOR 或 PATCH 版本

### 关键实体

- **模式定义源**: 包含驱动 SDK 生成的规范 TIDAS/ILCD 模式定义的外部依赖
- **SDK 制品**: 从模式定义派生的特定语言（Python 或 TypeScript）的生成 SDK 代码
- **流水线执行**: 由模式更改触发的单次自动化工作流运行，包含检测、生成、验证和发布
- **验证报告**: 代码质量检查和测试阶段的结果，包括通过/失败状态和错误详情
- **包发布**: 在包注册表中发布的 SDK 版本，包含版本号、元数据和制品文件

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 当模式定义源更新时，Python 和 TypeScript SDK 在 10 分钟内无需人工干预自动重新生成
- **SC-002**: 100% 的 SDK 重新生成在发布前都经过质量检查和测试的自动验证
- **SC-003**: SDK 发布在验证成功后 5 分钟内完成
- **SC-004**: 流水线失败提供可操作的错误消息，使开发人员能够在 15 分钟内识别和解决问题
- **SC-005**: 将手动 SDK 发布工作从约 2 小时减少到 10 分钟以内的无需人工干预的自动化处理
- **SC-006**: 95% 的流水线执行成功完成，无需人工干预或回滚

## 假设

- 项目使用标准的语言特定打包规范
- 模式定义源是 SDK 生成的唯一真实来源
- 现有的 SDK 生成工具可以通过自动化方式调用
- 包注册表凭证可以安全地提供给自动化流水线
- 流水线在具有外部依赖源和包注册表网络访问的环境中运行
- 语义化版本是所需的版本编号方案
